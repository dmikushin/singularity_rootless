Bootstrap: docker
From: ubuntu:22.04

%files
    ./dpkg /usr/bin/dpkg
    ./libfakechown.so /usr/lib/libfakechown.so

%post
    bash -c 'mv /usr/bin/dpkg /usr/bin/dpkg.real && echo -e "#!/bin/bash\ndpkg.real --force-not-root \"\$@\"" >/usr/bin/dpkg && chmod +x /usr/bin/dpkg'
    bash -c 'echo -e "#!/bin/bash\nLD_PRELOAD=/usr/lib/libfakechown.so \"\$@\"" >/usr/bin/sudo && chmod +x /usr/bin/sudo'
    sudo apt update
    DEBIAN_FRONTEND=noninteractive sudo apt install -y tzdata vim fish mc locales locales-all wget curl git gcc make libz-dev
    git clone https://github.com/dmikushin/dropbear.git
    cd dropbear
    mkdir build
    cd build
    ../configure
    make
    sudo make install
    cd ../..
    rm -rf dropbear
    mkdir -p /etc/dropbear
    bash -c 'echo -e "# /etc/shells: always use fish as a login shell\n/usr/bin/fish\n/bin/bash" >/etc/shells'

%startscript
    sudo /usr/local/sbin/dropbear -w -s -e -R -E -p ${1:-22221}

%environment
    export SINGULARITY_SHELL=/usr/bin/fish
